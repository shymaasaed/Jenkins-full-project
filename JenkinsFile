
pipeline {
  agent any

  environment {
    SONARQUBE_SERVER = "sonarqube"
    NEXUS_REPO_URL   = "http://localhost:8081/repository/spring-boot-app/"
    REGISTRY         = "docker.io/YOUR_DOCKER_USERNAME"
    IMAGE            = "spring-boot-app"
  }

  tools {
    maven 'maven'
    jdk 'jdk17'
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/shymaasaed/Jenkins-full-project'
      }
    }

    stage('Build + Test + Package') {
      steps {
        sh '''
          mvn -v
          mvn -B clean package
        '''
      }
    }

stage('SonarQube Scan') {
  steps {
    script {
      def scannerHome = tool 'sonar-scanner'
      withSonarQubeEnv('sonarqube') {
        sh """
          ${scannerHome}/bin/sonar-scanner \
          -Dsonar.projectKey=spring-boot-app \
          -Dsonar.projectName=spring-boot-app \
          -Dsonar.sources=src \
          -Dsonar.java.binaries=target
        """
      }
    }
  }
}

    stage('Publish to Nexus') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'nexus-creds', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
          sh '''
            cat > settings.xml <<EOF
<settings>
  <servers>
    <server>
      <id>nexus</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
  </servers>
</settings>
EOF

            mvn -B -DskipTests deploy \
              -s settings.xml \
              -DaltDeploymentRepository=nexus::default::${NEXUS_REPO_URL}
          '''
        }
      }
    }

    stage('Docker Build') {
      steps {
        sh '''
          docker build -t $REGISTRY/$IMAGE:$BUILD_NUMBER .
        '''
      }
    }

    stage('Docker Push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'shymaa145',
          usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh '''
            echo $PASS | docker login -u $USER --password-stdin
            docker push $REGISTRY/$IMAGE:$BUILD_NUMBER
          '''
        }
      }
    }

  }

  post {
    always {
      junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
      archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true, allowEmptyArchive: true
    }
  }
}
